(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{1335:function(e,t){},1339:function(e,t,n){"use strict";t.__esModule=!0;var i=o(n(26)),s=o(n(13)),r=o(n(1290));function o(e){return e&&e.__esModule?e:{default:e}}var a=3,u=4,d=5,c=function(){function e(){(0,s.default)(this,e),this.db=new r.default("intelliChat"),this.db.version(1).stores({interventions:"userId,uniqueId,interventionId,itemId,timestamp",interventionData:"id,type,priority"}),this.db.version(2).stores({interventions:null,interventionData:"id,type,priority"}),this.db.version(a).stores({interventions:"[userId+itemId],uniqueId,userId,interventionId,itemId,timestamp",interventionData:"id,type,priority"}),this.db.version(u).stores({interventions:null,interventionData:"id,type,priority"}),this.db.version(d).stores({interventions:"userItemId,uniqueId,userId,interventionId,itemId,timestamp",interventionData:"id,type,priority"}).upgrade(function(e){e.interventions.toCollection().modify(function(e){e.userItemId=e.userId+"_"+e.itemId})}),this.db.open().catch(function(e){return console.error(e)})}return e.prototype.saveInterventionIdData=function(e,t){return t.id=e,this.db.interventionData.put(t)},e.prototype.saveInterventionsData=function(e){var t=this;if(e.length){var n={},i=[];return e.forEach(function(e){if(e){var s=e.id.toString(),r={type:e.type,shownWindow:e.display_screen,text:e.display_text||"",actions:e.actions,priority:e.priority,invalidateConditions:e.remove_conditions,icon:e.icon};n[s]=r,i.push(t.saveInterventionIdData(s,r).catch(function(){}))}}),r.default.Promise.all(i).then(function(){return n}).catch(function(){})}return null},e.prototype.getInterventionsData=function(){return this.db.interventionData.toArray().then(function(e){var t={};return e.forEach(function(e){t[e.id]=e}),t})},e.prototype.getUserIntervention=function(e,t){return this.db.interventions.where("userItemId").equals(e+"_"+t).toArray()},e.prototype.getInterventionIdData=function(e){return this.db.interventionData.where("id").equals(e).toArray()},e.prototype.getRemoveConditions=function(e){return this.db.interventionData.where("id").equals(e).toArray().then(function(e){return e[0]&&e[0].invalidateConditions})},e.prototype.saveIntervention=function(e,t){var n=this,s=e.intervention,r=s.userId&&s.userId.split("_")[0],o=s.interventionId;return this.getUserIntervention(r,e.extras.itemId).then(function(a){var u=a[0];return n.getInterventionIdData(o).then(function(d){if(d.length){var c=d[0],l=c.priority,f=c.invalidateConditions&&c.invalidateConditions.expiry_time,h={},p=[];if(s.price&&(h.price=s.price),!u||l&&l<u.priority||e.extras.itemId!==a[0].itemId)return n.db.interventions.put({uniqueId:r+"_"+e.extras.itemId+"_"+o,interventionId:o,userId:r,itemId:e.extras.itemId,timestamp:t,params:h,priority:l,userItemId:r+"_"+e.extras.itemId,expiry:f&&t+1e3*f||"",id:e.id}).then(function(){return a.length&&p.push({event:"item_chat_interv_invalidated",data:{intervention_id:u.interventionId,interv_msg_id:u.id,item_id:u.itemId}}),p.push({event:"item_chat_interv_received",data:{intervention_id:s.interventionId,interv_msg_id:e.id,item_id:e.extras.itemId}}),p})}return i.default.reject()})})},e.prototype.updateInterventionSeenData=function(e,t,n){var i={seen:n};return this.db.interventions.update([e,t],i)},e.prototype.getActiveInterventions=function(){return this.db.interventions.toArray().then(function(e){var t={};return e.forEach(function(e){t[e.userId+"_"+e.itemId]=e}),t})},e.prototype.removeIntervention=function(e,t,n){return this.db.interventions.where("uniqueId").equals(e+"_"+t+"_"+n).delete()},e.prototype.removeUserIntervention=function(e,t){return this.db.interventions.where("userItemId").equals(e+"_"+t).delete()},e.prototype.clear=function(){return this.db.interventions.clear()},e}();t.default=c},1427:function(e,t){},1428:function(e,t){},1445:function(e,t){},1448:function(e,t){},1558:function(e,t,n){"use strict";t.__esModule=!0;var i=u(n(26));t.getUserMessages=function(e,t,n,s){var a="";e&&("number"!=typeof e&&(e=Date.parse(e)),a="time="+e);t&&(a=a?a+"&page="+t:"page="+t);a&&(n=n+"?"+a);return d(n,{method:"GET",mode:"cors",headers:{Accept:"application/json","Content-Type":"application/json","x-access-token":s},credentials:"include"}).then(function(e){return e.ok||e.status===r.statusCodes.UNAUTHORIZED?e.json():(e.status===r.statusCodes.SERVICE_UNAVAILABLE&&(0,o.setChatStatus)(!1),i.default.reject())}).then(function(e){return e&&"JsonWebTokenError"===e.code?{error:"invalid"}:e&&e.data?((0,o.setChatStatus)(!0),e):i.default.reject()})},t.getChatApiMetaData=function(e){if(!e||!e.hmacPwd)return i.default.reject();var t={method:"GET",mode:"cors",headers:{"x-request-id":(0,a.createHmac)("sha256",e.hmacPwd).update(e.featureApiHmacKey).digest("hex")},credentials:"include"};return d(e.featureApi,t).then(function(e){return e.ok?e.json():(e.status===r.statusCodes.SERVICE_UNAVAILABLE&&(0,o.setChatStatus)(!1),i.default.reject())}).then(function(e){(0,o.setChatStatus)(!0);var t=e&&e.data;return t||i.default.reject()})};var s=u(n(172)),r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(170)),o=n(396),a=n(1422);function u(e){return e&&e.__esModule?e:{default:e}}var d=(0,s.default)().fetch},1857:function(e,t,n){"use strict";t.__esModule=!0,t.ChatDatabase=void 0;var i=l(n(4)),s=l(n(105)),r=l(n(32)),o=l(n(1858)),a=l(n(13)),u=l(n(1290)),d=l(n(141)),c=n(380);function l(e){return e&&e.__esModule?e:{default:e}}function f(){var e=d.default.getState()||{};return e&&e.chat&&e.chat.messages}function h(){var e=d.default.getState()||{};return e&&e.chat&&e.chat.users}function p(){var e=d.default.getState()||{};return e&&e.chat&&e.chat.threadMessages}function m(e,t){var n=p();return n&&n[e+"_"+t]}var v=3,g=function e(){(0,a.default)(this,e),this.id=null,this.body=null,this.itemId=null,this.userId=null,this.userItemId=null,this.from=null,this.to=null,this.date=null,this.isMine=null,this.location=null,this.image=null,this.voice=null,this.info=null,this.sms=null,this.call=null,this.type=null,this.system=null,this.displayed=null,this.received=null,(0,o.default)(this)};t.ChatDatabase=function(){function e(){(0,a.default)(this,e),this.db=new u.default("chat"),this.db.version(1).stores({messages:"id,body,itemId,from,to,date",users:"id"}),this.db.version(2).stores({messages:"id,body,itemId,from,to,date,userId,[userId+itemId]",users:"id"}).upgrade(function(e){e.messages.toCollection().modify(function(e){e.userId=e.isMine?e.to:e.from})}),this.db.version(v).stores({messages:"id,body,itemId,from,to,date,userId,userItemId",users:"id"}).upgrade(function(e){e.messages.toCollection().modify(function(e){e.userItemId=e.userId+"_"+e.itemId})}),this.db.open().then(function(){}).catch(function(e){return console.error("error in on receive functionsss",e)})}return e.prototype.getLastMessageByThread=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},i=m(e,t)||[];return i.sort(function(e,t){return t.date-e.date}),n(),i[0]},e.prototype.getUnreadThreads=function(e,t){var n=this,i=0,s=p();s&&(0,r.default)(s).map(function(e){var t=e.split("_"),s=n.getUnreadCountByThread(t[0],t[1]);i+=s}),t(i)},e.prototype.getNewReceivedSystemMessages=function(){return(0,s.default)(f()).filter(function(e){return e.system&&!e.received})},e.prototype.getUnreadCountByThread=function(e,t){return(m(e,t)||[]).reduce(function(e,t){return e+(t.info||t.displayed||t.isMine?0:1)},0)},e.prototype.getDistinctConversationId=function(e){return this.db.messages.where("userId").equals(e).toArray().then(function(e){return e.map(function(e){return e.itemId}).filter(function(e,t,n){return n.indexOf(e)===t})})},e.prototype.getThreads=function(e,t){var n=this,i=[],s=p();s&&(i=(0,r.default)(s).map(function(e){var t=e.split("_"),i=n.getLastMessageByThread(t[0],t[1]),s=n.getUnreadCountByThread(t[0],t[1]);return{userId:t[0],lastMessage:i,unreadCount:s,itemId:t[1]}})),t(i=i.sort(function(e,t){return t.lastMessage.date-e.lastMessage.date}))},e.prototype.getThreadMessages=function(e,t,n){return n((m(e,t)||[]).sort(function(e,t){return e.date-t.date}))},e.prototype.getUsers=function(e,t){var n=h(),s=(0,i.default)({},n);delete s[e],t(s)},e.prototype.getUser=function(e){(arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){})((h()||{})[e])},e.prototype.addUser=function(e){return d.default.dispatch({type:"SAVE_USER",data:{user:e}}),this.db.users.add(e)},e.prototype.getItems=function(){var e={};return(0,r.default)(p()).forEach(function(t){e[t.split("_")[1]]=!0}),(0,r.default)(e)},e.prototype.getMessageById=function(e,t){return t((f()||{})[e])},e.prototype.getMessageDataById=function(e){return(f()||{})[e]},e.prototype.addMessage=function(e){return e instanceof g?(d.default.dispatch((0,c.saveMessage)({message:e,itemId:e.itemId,userId:e.userId})),this.db.messages.add(e)):null},e.prototype.addMessages=function(e){var t=this;return d.default.dispatch((0,c.saveMessages)({messages:e})),e.map(function(e){return t.db.messages.add(e)})},e.prototype.fetchData=function(e){var t=this;return this.db.messages.toArray().then(function(n){var i=n.filter(function(t){return t.to!==e&&t.from!==e}),s=n.filter(function(t){return t.to===e||t.from===e});i.forEach(function(n){window.newrelic.addPageAction("message_mismatch",{user_id:e,to_id:n.to,from_id:n.from,message_id:n.id,message:n}),t.removeMessage(n.id)}),d.default.dispatch((0,c.saveMessages)({messages:s}))})},e.prototype.syncUserData=function(){return this.db.users.toArray().then(function(e){e.forEach(function(e){d.default.dispatch({type:"SAVE_USER",data:{user:e}})})})},e.prototype.getLastMessageTimeStamp=function(){return this.db.messages.orderBy("date").reverse().limit(1).toArray().then(function(e){return e[0]}).then(function(e){return e&&e.date})},e.prototype.markReceived=function(e,t){var n=(f()||{})[e];if(n){var s=(0,i.default)({},n,{received:!0});d.default.dispatch((0,c.saveMessage)({message:s,itemId:s.itemId,userId:s.userId}))}return t(),this.db.messages.update(e,{received:!0}).catch(function(e){return console.log(e)})},e.prototype.markDisplayed=function(e,t){var n=(f()||{})[e];if(n){var s=(0,i.default)({},n,{displayed:!0});d.default.dispatch((0,c.saveMessage)({message:s,itemId:s.itemId,userId:s.userId}))}return t(),this.db.messages.update(e,{displayed:!0}).catch(function(e){return console.log("cant mark",e)})},e.prototype.updatePresence=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},s=h();if(s&&s[e]){var r=s[e],o=(0,i.default)({},r,{presence:t});return d.default.dispatch({type:"SAVE_USER",data:{user:o}}),n(o),this.db.users.update(r,{presence:t}).catch(function(e){return console.log(e)})}return n(),null},e.prototype.updateBlock=function(e,t,n){var s=h();if(s&&s[e]){var r=s[e],o=(0,i.default)({},r,{isBlock:t});return d.default.dispatch({type:"SAVE_USER",data:{user:o}}),n(o),this.db.users.update(e,{isBlock:t}).catch(function(e){return console.log(e)})}return n(),null},e.prototype.deleteUserChats=function(e,t){return d.default.dispatch({type:"REMOVE_MESSAGE",data:{itemId:t,userId:e}}),t?this.db.messages.where("userItemId").equals(e+"_"+t).delete():this.db.messages.where("userId").equals(e).delete()},e.prototype.removeMessage=function(e){return this.db.messages.where("id").equals(e).delete()},e.prototype.resetUserPresence=function(e){var t=h(),n=(0,i.default)({},t);return delete n[e],(0,s.default)(n).forEach(function(e){var t=(0,i.default)({},e,{presence:"unavailable"});d.default.dispatch({type:"SAVE_USER",data:{user:t}})}),this.db.users.where("id").notEqual(e).modify(function(e){e.presence="unavailable"}).catch(function(e){return console.log(e)})},e.prototype.searchMessages=function(e){var t=(0,s.default)(f()),n=new RegExp(e,"gi");return t.filter(function(e){return!e.info&&!e.call&&!e.sms&&!e.image&&!e.location&&!e.voice&&!e.system&&n.test(e.body)}).reverse().sort(function(e,t){return t.date-e.date})},e.prototype.getNewMessage=function(){return new g},e.prototype.cleanDb=function(){return this.db.delete()},e}()},864:function(e,t,n){"use strict";t.__esModule=!0;var i=g(n(56)),s=g(n(14)),r=g(n(90)),o=g(n(13)),a=g(n(26)),u=n(1558),d=g(n(1290)),c=g(n(1639)),l=g(n(37)),f=g(n(89)),h=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(392)),p=g(n(1339)),m=g(n(141)),v=n(1857);function g(e){return e&&e.__esModule?e:{default:e}}var y=50,b=new p.default,I=!1,_=void 0,w=void 0,C=!1,S=new a.default(function(e){w=e}),k=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(){},d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:function(){},c=this,p=arguments[6],m=arguments[7];(0,o.default)(this,e),this.updatePresence=function(e,t){var n=c.removeCountryCode(e.from.local),i="object"===(0,r.default)(e.idle)?"unavailable":e.type;return n===c.addCountryCode(c.user.id)||"subscribed"===i||"error"===i?a.default.resolve():"subscribe"===i?(c.acceptSubscription(n),a.default.resolve()):(c.userPresence[n]=i,_.updatePresence(n,i,t))},this.setTracker=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};c.tracker=e},_=new v.ChatDatabase,this.config=m,this.connEstablished=!1,this.mamStart=void 0,this.domain=this.config.domain,this.retryTime=this.config.retryTime,this.retryTrail=this.config.retryTrail,this.refreshUserPresence=n,this.user=JSON.parse(decodeURIComponent(f.default.readCookie("user")).substr(2)),this.latestMsgObj={},this.blockList=[],this.userPresence={},this.updateTime=!1,this.mamEnabled=this.checkIfMamEnabled(),this.getJWTCount=0,this.setTracker();var g=this.getStorageItem("__ct__bifro_ct"),b=f.default.readCookie("ct");g?h.decrypt(g,"#"+this.user.id+"#").then(function(e){"boolean"==typeof e||e.length>y?c.refreshChatToken(function(){var e=c.getStorageItem("__ct__bifro_ct");h.decrypt(e,"#"+c.user.id+"#").then(function(r){r?c.setData(r,t,n,i,s,u,d,p):e.length===y?c.setData(e,t,n,i,s,u,d,p):l.default.fetchToken().then(function(e){e&&c.setData(e,t,n,i,s,u,d,p)})})}):c.setData(e,t,n,i,s,u,d,p)}):b&&"undefined"!==b&&void 0!==b?this.setData(b,t,n,i,s,u,d,p):window.localStorage?this.refreshChatToken(function(){var e=c.getStorageItem("__ct__bifro_ct");h.decrypt(e,"#"+c.user.id+"#").then(function(r){r?c.setData(r,t,n,i,s,u,d,p):e.length===y?c.setData(e,t,n,i,s,u,d,p):l.default.fetchToken().then(function(e){e&&c.setData(e,t,n,i,s,u,d,p)})})}):l.default.fetchToken().then(function(e){e&&c.setData(e,t,n,i,s,u,d,p)})}return e.prototype.checkIfMamEnabled=function(){var e=this.getStorageItem("_bifro_features");return e&&!JSON.parse(e).http_chat_history||!1},e.prototype.refreshChatToken=function(e){return l.default.regenerateToken(e)},e.prototype.setData=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(){},r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:function(){},o=this,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:function(){},u=arguments[7],d=window&&window.screen.availWidth<768?"pwaMobile":"pwaDesktop";this.chatToken=e,this.checkAuthToken(this.chatToken,r,"constructor")?(this.obj={jid:this.addFullCode(this.user.id),password:this.chatToken,transport:"websocket",resource:d+"-"+Date.now(),useStreamManagement:!0,wsURL:this.config.wsUrl,timeout:5e4},this.client=c.default.createClient(this.obj),this.client.use(this.setCustomMessage.bind(this)),this.client.use(this.setChatMarkers.bind(this)),this.client.on("session:started",function(){o.mamStart=!0,u({state:"start"}),o.onSessionStart().then(a(o.connEstablished))}),this.client.on("stream:management:resumed",function(){o.sendConnectionStatus(a,!0)}),this.client.on("message:sent",function(e){C?("chat"===e.type&&o.tracker("item_chat_tap_send_success",{resultset_id:e.id}),o.saveMessage(e).then(function(){return o.client.emit("messages:received")},function(){})):S.then(function(){"chat"===e.type&&o.tracker("item_chat_tap_send_success",{resultset_id:e.id}),o.saveMessage(e).then(function(){return o.client.emit("messages:received")},function(){})})}),this.client.on("chat",function(e){C?o.saveMessage(e).then(function(){return o.client.emit("messages:received")},function(){}):S.then(function(){o.saveMessage(e).then(function(){return o.client.emit("messages:received")},function(){})})}),this.client.on("disconnected",function(){o.onChatDisconnect(a)}),this.client.on("auth:failed",function(e){o.trackAuthFailure(e),o.updateAuthEvents(r)}),this.client.on("message:receipt",function(e){o.markReceived(e,function(){return o.client.emit("messages:received")})}),this.client.on("message:displayed",function(e){o.markDisplayed(e,function(){return o.client.emit("messages:received")})}),this.client.on("mamComplete",function(e){u(e)}),this.client.on("jwt:saved",function(){o.getUserMessages()}),this.client.on("intervention:change",function(e){i(e)}),this.client.on("custom:chat:state",function(e){return s(e)}),this.updateUserEvents(n),this.client.on("messages:received",t),this.client.connect(),M(this.config),_.syncUserData()):I=!1},e.prototype.replaceListeners=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(){},r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:function(){},o=this,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:function(){},u=arguments[7];this.checkAuthToken(this.chatToken,s,"update")&&u&&(this.mamStart?a({state:"start"}):!1===this.mamStart?a({state:"end"}):a({state:"continue"}),this.client.off("custom:chat:state"),this.client.on("custom:chat:state",function(e){return i(e)}),this.client.off("messages:received"),this.client.on("messages:received",e),this.client.off("session:started"),this.client.on("session:started",function(){o.mamStart=!0,a({state:"start"}),o.onSessionStart().then(r(o.connEstablished))}),this.client.off("stream:management:resumed"),this.client.on("stream:management:resumed",function(){o.sendConnectionStatus(r,!0)}),this.client.off("disconnected"),this.client.on("disconnected",function(){o.onChatDisconnect(r)}),this.client.off("auth:failed"),this.client.on("auth:failed",function(e){o.trackAuthFailure(e),o.updateAuthEvents(s)}),this.client.off("mamComplete"),this.client.on("mamComplete",function(e){a(e)}),this.client.off("intervention:change"),this.client.on("intervention:change",function(e){n(e)}),r(this.connEstablished),this.refreshUserPresence=t,this.updateUserEvents(t))},e.prototype.onChatDisconnect=function(e){this.client&&(this.onMamEnd(),this.sendConnectionStatus(e,!1))},e.prototype.retryChatConnection=function(){var e=this;this.retryTrail===this.config.retryTrail?(this.retryTrail--,this.connect()):this.retryTrail>0&&(this.retryTrail--,setTimeout(function(){e.connect()},this.retryTime))},e.prototype.resetRetryTimer=function(){this.retryTrail!==this.config.retryTrail&&(this.retryTrail=this.config.retryTrail)},e.prototype.sendConnectionStatus=function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.connEstablished=t,I=!1,this.setHealthStatus(),e(t,n,this.retryTrail===this.config.retryTrail),!t&&window.navigator&&window.navigator.onLine&&this.retryChatConnection()},e.prototype.updateUserEvents=function(e){var t=this;this.client.off("presence"),this.client.on("presence",function(n){t.updatePresence(n,e)}),this.client.off("block"),this.client.on("block",function(n){n.jids.forEach(function(n){t.blockList.push(n.local),t.updateBlock(t.removeCountryCode(n.local),!0,e)})}),this.client.off("unblock"),this.client.on("unblock",function(n){n.jids.forEach(function(n){var i=t.blockList.indexOf(n.local);t.blockList.splice(i,1),t.updateBlock(t.removeCountryCode(n.local),!1,e)})})},e.prototype.updateAuthEvents=function(e){this.retryTrail<=0&&e(!0,this.chatToken)},e.prototype.trackAuthFailure=function(e){window.newrelic.addPageAction("chat_auth_failed",{event_message:e&&e.data,resource:this.client.config?""+String(this.client.config.resource):"null",token:this.client.config?""+String(this.client.config.password):"null",loc:window.location&&window.location.pathname,isLoggedIn:l.default.isLoggedIn(),user:this.user,local_token:this.getStorageItem("__ct__bifro_ct")?""+String(this.getStorageItem("__ct__bifro_ct")):"null",cookie_token:f.default.readCookie("ct")?""+String(f.default.readCookie("ct")):"null"})},e.prototype.checkAuthToken=function(e,t,n){return!(!e||"null"===e||"undefined"===e)||(window.newrelic.addPageAction("chat_auth_error",{token:this.getStorageItem("__ct__bifro_ct"),user:this.user,calledBy:n,chat_token:e,cookie_token:f.default.readCookie("ct"),loc:window.location&&window.localStorage.pathname}),t(!0,e),!1)},e.prototype.setCustomMessage=function(e,t){var n=this;e.disco.addFeature("jabber:iq:mamremove");var i=t.define({name:"extras",element:"extras",topLevel:!0,namespace:"urn:xmpp:extras",fields:{countryId:t.utils.attribute("countryId"),itemId:t.utils.attribute("itemId"),actionId:t.utils.attribute("actionId"),interventionId:t.utils.attribute("interventionId"),senderType:t.utils.attribute("senderType"),params:t.utils.attribute("params")}}),s=t.define({name:"store",element:"store",namespace:"urn:xmpp:hints"}),r=t.define({name:"idle",element:"idle",namespace:"urn:xmpp:idle:1",fields:{since:t.utils.attribute("since")}}),o=t.define({name:"query",element:"query",namespace:"jabber:iq:last",fields:{seconds:t.utils.attribute("seconds")}}),a=t.define({name:"info",element:"info",topLevel:!0,namespace:"urn:xmpp:type"}),u=t.define({name:"text",element:"text",topLevel:!0,namespace:"urn:xmpp:type"}),d=t.define({name:"image",element:"image",topLevel:!0,namespace:"urn:xmpp:type",fields:{url:t.utils.attribute("url"),thumb:t.utils.attribute("thumb")}}),c=t.define({name:"voice",element:"voice",topLevel:!0,namespace:"urn:xmpp:type",fields:{url:t.utils.attribute("url"),duration:t.utils.attribute("duration")}}),l=t.define({name:"location",element:"location",topLevel:!0,namespace:"urn:xmpp:type",fields:{lat:t.utils.attribute("lat"),lon:t.utils.attribute("lon")}}),f=t.define({name:"intervention",element:"intervention",topLevel:!0,namespace:"urn:xmpp:type",fields:{action:t.utils.attribute("action"),interventionId:t.utils.attribute("id"),userId:t.utils.attribute("with"),price:t.utils.subAttribute("urn:xmpp:type","params","price")}}),h=t.define({name:"deleteChat",element:"query",topLevel:!0,namespace:"jabber:iq:mamremove",fields:{jid:t.utils.textSub("jabber:iq:mamremove","jid"),adid:t.utils.textSub("jabber:iq:mamremove","adid")}}),p=t.define({name:"response",element:"result",namespace:"jabber:iq:mamremove",type:"set",fields:{ns:t.utils.attribute("xmlns"),id:t.utils.attribute("id"),jid:t.utils.textSub("jabber:iq:mamremove","jid"),adid:t.utils.textSub("jabber:iq:mamremove","adid")}}),m=t.define({name:"sms",element:"sms",topLevel:!0,namespace:"urn:xmpp:type"}),v=t.define({name:"call",element:"call",topLevel:!0,namespace:"urn:xmpp:type"}),g=t.define({name:"event",element:"query",namespace:"jabber:iq:event",fields:{name:t.utils.textSub("jabber:iq:event","name"),to:t.utils.textSub("jabber:iq:event","to"),itemId:t.utils.textSub("jabber:iq:event","itemId"),senderType:t.utils.textSub("jabber:iq:event","senderType")}}),y=t.define({name:"jwtToken",element:"query",namespace:"jabber:iq:jwt",fields:{jwt:t.utils.textSub("jabber:iq:jwt","jwt")}}),b=t.define({name:"deeplink",element:"deeplink",namespace:"urn:xmpp:deeplinks:item",fields:{label:t.utils.textSub("urn:xmpp:deeplinks:item","label"),link:t.utils.textSub("urn:xmpp:deeplinks:item","link")}}),I=t.define({name:"deeplinks",element:"deeplinks",namespace:"urn:xmpp:deeplinks"}),_=t.define({name:"system",element:"system",topLevel:!0,namespace:"urn:xmpp:type",fields:{layout:t.utils.attribute("layout"),useDefault:t.utils.attribute("useDefault"),subType:t.utils.attribute("subType"),icon:t.utils.textSub("urn:xmpp:type","icon"),title:t.utils.textSub("urn:xmpp:type","title"),subtitle:t.utils.textSub("urn:xmpp:type","subtitle"),email:t.utils.textSub("urn:xmpp:type","email"),actionLabel:t.utils.textSub("urn:xmpp:type","action_label")}});t.extend(I,b),t.extend(_,I),t.withPresence(function(e){t.extend(e,r)}),t.withIQ(function(e){t.extend(e,o),t.extend(e,h),t.extend(e,p),t.extend(e,g),t.extend(e,y)}),t.withMessage(function(e){t.extend(e,i),t.extend(e,s),t.extend(e,a),t.extend(e,u),t.extend(e,d),t.extend(e,c),t.extend(e,l),t.extend(e,m),t.extend(e,v),t.extend(e,f),t.extend(e,_)}),e.on("iq",function(e){var t=e&&e.response,i=e&&e.jwtToken;t&&"jabber:iq:mamremove"===t.ns&&n.deleteUserChats(n.removeCountryCode(t.id),t.adid),i&&i.jwt&&n.saveJwtToken(i.jwt)})},e.prototype.setChatMarkers=function(e,t){var n=this;e.disco.addFeature("urn:xmpp:chat-markers:0");var i=t.define({name:"markable",element:"markable",namespace:"urn:xmpp:chat-markers:0"}),s=t.define({name:"displayed",element:"displayed",namespace:"urn:xmpp:chat-markers:0",fields:{id:t.utils.attribute("id")}}),o=t.define({name:"received",element:"received",namespace:"urn:xmpp:chat-markers:0",fields:{id:t.utils.attribute("id")}});t.withMessage(function(e){t.extend(e,i),t.extend(e,s),t.extend(e,o)}),e.on("message",function(t){t.from.local!==n.addCountryCode(n.user.id)&&(t.displayed?e.emit("message:displayed",t.displayed.id):t.received?e.emit("message:receipt",t.received.id):!t.markable||t.error&&"503"===t.error.code||n.sendReceived(t)),"object"===(0,r.default)(t.intervention)&&n.saveIntervention(t,Date.now()),t.chatState&&e.emit("custom:chat:state",{to:t.to,from:t.from,chatState:t.chatState,extras:t.extras})})},e.prototype.setHealthStatus=function(){var e=this;clearInterval(this.timeout),this.connEstablished&&(this.timeout=setInterval(function(){e.client.sendIq({id:"c2s1",type:"get",ping:!0})},4e4))},e.prototype.getJwtToken=function(){this.client.sendIq({type:"get",jwtToken:!0,from:this.addFullCode(this.user.id)})},e.prototype.onSessionStart=function(){var e=this;if(this.connEstablished=!0,I=!1,this.client.enableCarbons(function(e){e&&console.log("Server does not support carbons",e)}),this.resetRetryTimer(),this.sendPresence(),this.client.getBlocked(function(t,n){t||n.blockList&&n.blockList.jids&&(e.blockList=n.blockList.jids.map(function(e){return e.local}))}),this.mamEnabled){this.updateTime=!0;var t={rsm:{max:this.config.maxMessages,before:!0}},n=this.getStorageItem("_bifro_time");n&&(t.start=new Date(n).toISOString()),this.searchHistory(t)}else this.getJwtToken();return this.setHealthStatus(),a.default.resolve()},e.prototype.saveJwtToken=function(e){window&&window.localStorage&&(window.localStorage.setItem("_bifro_jwt",e),this.client.emit("jwt:saved"))},e.prototype.loadDataFromDB=function(){return _.fetchData(this.user.id)},e.prototype.getLastMessageTimeStamp=function(){return _.getLastMessageTimeStamp()},e.prototype.getUserMessages=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=this.getStorageItem("_bifro_time");this.loadDataFromDB(),this.sendHttpRequest(e,t),w(),C=!0},e.prototype.sendHttpRequest=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getStorageItem("_bifro_time");this.client.emit("mamComplete",{state:"continue"}),(0,u.getUserMessages)(n,t,this.config.myChatsApi,this.getStorageItem("_bifro_jwt")).then(function(t){if(t){var n=t.data;if("invalid"===t.error)return e.getJWTCount<e.config.retryTrail?(e.getJWTCount++,e.getJwtToken()):e.onMamEnd(),null;if(e.getJWTCount=0,n.length){e.client.emit("mamComplete",{state:"continue"});var i=n[n.length-1],s=parseInt(i.timestamp,10);t.next_page?e.sendHttpRequest(t.next_page,s):(e.updateTime=!0,e.onMamEnd()),e.saveHttpMessages(n,function(){e.updateQueryTime(new Date(s),!0)})}else e.updateTime=!0,e.onMamEnd()}return null})},e.prototype.searchHistory=function(e,t){var n=this;this.client.searchHistory(e,function(i,s){if(!i){var r=s.mamResult.items||[],o=t||[],a=r.length,u=void 0;if(a){var c=r.map(function(e){var t=e.forwarded.message.to.local,i=e.forwarded.message.from.local;return t===n.addCountryCode(n.user.id)?i:t}).filter(function(e,t,n){return n.indexOf(e)===t});d.default.Promise.all(c.forEach(function(e){return n.saveUser(n.removeCountryCode(e))})).then(function(){var e=[];return n.client.emit("mamComplete",{state:"continue"}),r.forEach(function(t){var i=(u=t.forwarded.message).displayed&&u.displayed.id;i?o.indexOf(i)<0&&o.push(i):e.push(n.saveMessage(u,!0).catch(function(){}))}),d.default.Promise.all(e)}).then(function(){return a>=n.config.maxMessages&&e.rsm.before!==s.mamResult.rsm.first?(n.getPreviousPage(s.mamResult.rsm.first,o),n.client.emit("messages:received"),null):(n.client.emit("messages:received"),n.client.emit("mamComplete",{state:"continue"}),d.default.Promise.all(o.forEach(function(e){return n.markDisplayed(e)})).then(function(){n.client.emit("messages:received"),n.refreshUserPresence(),n.onMamEnd()}))}).catch(function(){n.client.emit("messages:received"),n.onMamEnd()})}else n.onMamEnd()}})},e.prototype.onMamEnd=function(){this.mamStart=!1,this.client.emit("mamComplete",{state:"end",latestMsgs:this.latestMsgObj})},e.prototype.updateQueryTime=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];(this.updateTime||t)&&this.getStorageItem("_bifro_time")!==e&&window.localStorage.setItem("_bifro_time",e)},e.prototype.getPreviousPage=function(e,t){var n={rsm:{max:this.config.maxMessages,before:e}};this.searchHistory(n,t)},e.prototype.getLastActivity=function(e){return this.connEstablished?this.client.sendIq({to:this.addFullCode(e),type:"get",id:"last1",query:!0}):a.default.resolve()},e.prototype.getLastMessageByThread=function(e,t,n){return _&&_.getLastMessageByThread(e,t,n)},e.prototype.waitTillGetLastMessageByThread=function(e,t,n){return S.then(function(){return _&&_.getLastMessageByThread(e,t,n)})},e.prototype.getUnreadThreads=function(e){return _.getUnreadThreads(this.user.id,e)},e.prototype.getNewReceivedSystemMessages=function(e){return _.getNewReceivedSystemMessages(e)},e.prototype.getUnreadCountByThread=function(e,t){return _.getUnreadCountByThread(e,t)},e.prototype.getDistinctConversationId=function(e){return _.getDistinctConversationId(e)},e.prototype.convertToString=function(e){return e&&("string"==typeof e?e:e.toString())},e.prototype.removeCountryCode=function(e){return e&&this.convertToString(e).split("_")[0]},e.prototype.addCountryCode=function(e){return e&&this.convertToString(e).concat("_"+this.domain)},e.prototype.addFullCode=function(e){return e&&this.convertToString(e).concat("_"+this.domain+"@"+this.domain)},e.prototype.hasCountryCode=function(e){return e&&this.convertToString(e).split("_").length>1},e.prototype.getStorageItem=function(e){if("undefined"!=typeof window){var t=window.localStorage;return t&&t.getItem(e)}return null},e.prototype.getThreads=function(e){return _.getThreads(this.user.id,e)},e.prototype.getThreadMessages=function(e,t,n){return _.getThreadMessages(e,t,n)},e.prototype.getUsers=function(e){return _.getUsers(this.user.id,e)},e.prototype.getUser=function(e){return _.getUser(e)},e.prototype.getItems=function(e){return _.getItems(e)},e.prototype.markReceived=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};return _.markReceived(e,t)},e.prototype.markDisplayed=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};return this.connEstablished?_.markDisplayed(e,function(){t()}):null},e.prototype.updateBlock=function(e,t,n){return e===this.user.id?a.default.resolve():_.updateBlock(e,t,n)},e.prototype.sendDisplayed=function(e){return this.setHealthStatus(),this.client.sendMessage({to:this.addFullCode(e.from),displayed:{id:e.id},from:this.addFullCode(e.to),type:"chat",store:!0,markable:!0,extras:{itemId:e.itemId,countryId:""+this.domain}}),this.markDisplayed(e.id)},e.prototype.sendReceived=function(e){this.setHealthStatus();var t=e.extras;return this.client.sendMessage({to:this.hasCountryCode(e.from)?e.from:this.addFullCode(e.from),received:{id:e.id},from:this.hasCountryCode(e.to)?e.to:this.addFullCode(e.to),type:"chat",markable:!0,extras:{itemId:t?t.itemId:e.itemId,countryId:""+this.domain}}),this.markReceived(e.id)},e.prototype.deleteUserChats=function(e,t){var n=this;return _.deleteUserChats(e,t).then(function(){return n.client.emit("messages:received")})},e.prototype.isMessage=function(e){return e.body||"object"===(0,r.default)(e.text)||"object"===(0,r.default)(e.call)||"object"===(0,r.default)(e.image)||"object"===(0,r.default)(e.voice)||"object"===(0,r.default)(e.location)||"object"===(0,r.default)(e.sms)||"object"===(0,r.default)(e.system)},e.prototype.isHttpMessage=function(e){return e.text||"call"===e.type||"sms"===e.type||"image"===e.type||"location"===e.type||"voice"===e.type||"image"===e.type||"system"===e.type},e.prototype.saveIntervention=function(e,t){var n=this;return b.saveIntervention(e,t).then(function(e){n.client.emit("intervention:change",e)})},e.prototype.saveMessage=function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=e&&e.delay&&e.delay.stamp&&e.delay.stamp.getTime()||(new Date).getTime();if(e.displayed||e.received)return a.default.resolve();if("object"===(0,r.default)(e.intervention))return this.saveIntervention(e,i),a.default.reject();if(!this.isMessage(e))return a.default.reject();var s=e.id;if(void 0===s)return a.default.reject();var o=void 0,u=_.getNewMessage();return u.id=s,u.body=e.body,u.itemId=e.extras?e.extras.itemId:null,u.from=this.removeCountryCode(e.from.local),u.to=this.removeCountryCode(e.to.local),u.date=i,u.isMine=this.removeCountryCode(e.from.local)===this.user.id,u.userId=u.isMine?this.removeCountryCode(e.to.local):this.removeCountryCode(e.from.local),u.location="object"===(0,r.default)(e.location)&&e.location,u.image="object"===(0,r.default)(e.image)&&e.image,u.voice="object"===(0,r.default)(e.voice)&&e.voice,u.info="object"===(0,r.default)(e.info),u.sms="object"===(0,r.default)(e.sms),u.call="object"===(0,r.default)(e.call),u.type=e.type,u.system="object"===(0,r.default)(e.system)&&e.system,u.userItemId=u.userId+"_"+u.itemId,_.getMessageById(s,function(i){if(void 0===(o=i)){if(u.received=n,n&&t.saveLatestMsgDate(u),_.addMessage(u).catch(function(e){e&&e.message&&-1!==e.message.indexOf("Quota")&&t.logMessageSaveError(e,"chat_send_message_save_failed")}),void 0===o){var s=e.from.local===t.addCountryCode(t.user.id)?e.to.local:e.from.local;return s===t.addCountryCode(t.user.id)?null:t.saveUser(t.removeCountryCode(s))}return a.default.resolve()}return null}),a.default.resolve()},e.prototype.saveHttpMessages=function(e,t){var n=this;try{var i=e.reduce(function(e,t){var i=n.formatHttpMessage(t);return i&&e.push(i),e},[]);return this.saveHttpMessageList(i).then(function(e){return n.client.emit("messages:received"),e?t():null})}catch(e){return e&&e.message&&-1!==e.message.indexOf("Quota")&&this.logMessageSaveError(e,"chat_api_message_save_failed"),null}},e.prototype.formatHttpMessage=function(e){var t=e.msg_id;if(!this.isHttpMessage(e)||void 0===t||"intervention"===e.type)return null;"system"===e.type&&(e.type_data=this.alterSystemMessage(e.type_data));var n=_.getNewMessage();n.id=t,n.body=e.text,n.itemId=e.ad_id,n.from=e.sender_id,n.to=e.receiver_id,n.date=parseInt(e.timestamp,10),n.isMine=e.sender_id===this.user.id,n.userId=n.isMine?e.receiver_id:e.sender_id,n.location="location"===e.type&&e.type_data,n.image="image"===e.type&&e.type_data,n.voice="voice"===e.type&&e.type_data,n.info="info"===e.type,n.sms="sms"===e.type,n.call="call"===e.type,n.type="chat",n.system="system"===e.type&&e.type_data,n.displayed="displayed"===e.status,n.received="received"===e.status,n.userItemId=n.userId+"_"+n.itemId;var i=_.getMessageDataById(t);if(void 0===i){n.to!==this.user.id||n.displayed||n.received||this.sendReceived(n),n.received=!0,this.saveLatestMsgDate(n);var s=n.from===this.user.id?n.to:n.from;return s!==this.user.id&&this.saveUser(s),n}return i&&!i.displayed&&n.displayed?this.markDisplayed(t):i&&!i.received&&n.received&&this.markReceived(t),i},e.prototype.saveHttpMessageList=function(e){var t=this,n=_.addMessages(e);return a.default.all(n).then(function(e){return!!(e&&e.length&&e[e.length-1])}).catch(function(e){return e&&e.message&&-1!==e.message.indexOf("Quota")&&t.logMessageSaveError(e,"chat_api_message_save_failed"),!1})},e.prototype.logMessageSaveError=function(e,t){var n=this;"storage"in window.navigator&&"estimate"in window.navigator.storage?window.navigator.storage.estimate().then(function(i){var s=i.usage,r=i.quota;window.newrelic.addPageAction(t,{user_id:n.user.id,error:e,usage:s,quota:r})}):window.newrelic.addPageAction(t,{user_id:this.user.id,error:e})},e.prototype.alterSystemMessage=function(e){var t=e;if(e.action_label&&(t.actionLabel=e.action_label,delete t.action_label),"layout_item_deeplink"===e.layout){var n=JSON.parse(e.deeplinks);t.deeplinks={deeplink:n.deeplinks[0]}}return t},e.prototype.saveLatestMsgDate=function(e){var t=e.isMine,n=t?e.to:e.from;this.latestMsgObj[n]=this.latestMsgObj[n]||{},this.latestMsgObj[n][t?"sent":"received"]=e.date},e.prototype.saveUser=function(e){var t=this;return _.getUser(e,function(n){return void 0===n?(t.subscribe(e),t.acceptSubscription(e),_.addUser({id:e,presence:t.userPresence[e]||"unavailable",isBlock:t.blockList.includes(t.addCountryCode(e))})):null})},e.prototype.sendMessage=function(e,t,n,i,r,o){var a={to:this.addFullCode(t),from:this.addFullCode(this.user.id),body:e,type:"chat",state:"active",markable:!0,extras:{itemId:n,countryId:""+this.domain,senderType:o===this.user.id?"seller":"buyer"}};return"info"===i?a.info=!0:"image"===i?a.image=r:"voice"===i?a.voice=r:"location"===i?a.location=r:"sms"===i?a.sms=!0:"call"===i?a.call=!0:("intervention"===i&&(a.extras=(0,s.default)({},a.extras,r)),a.text=!0),this.setHealthStatus(),this.client.sendMessage(a)},e.prototype.sendThreadOpenEvent=function(e,t,n){this.client.sendIq({type:"set",event:{name:"chat_window_open",to:this.addFullCode(t),itemId:e,senderType:n===this.user.id?"seller":"buyer"},from:this.addFullCode(this.user.id)})},e.prototype.sendState=function(e,t,n){this.connEstablished&&(this.setHealthStatus(),this.client.sendMessage({to:this.addFullCode(e),chatState:t,extras:{itemId:n},from:this.addFullCode(this.user.id)}))},e.prototype.blockUser=function(e){var t=this.addFullCode(e);return this.sendPresenceToUser("unavailable",t),this.client.block(t)},e.prototype.unblockUser=function(e){var t=this,n=this.addFullCode(e);return this.client.unblock(n,function(){t.sendPresenceToUser("available",n)})},e.prototype.deleteChat=function(e,t){return this.client.sendIq({type:"set",deleteChat:{jid:this.addFullCode(e),adid:t}})},e.prototype.subscribe=function(e){this.client.subscribe(this.addFullCode(e))},e.prototype.acceptSubscription=function(e){this.client.acceptSubscription(this.addFullCode(e))},e.prototype.sendPresence=function(e){this.connEstablished&&("idle"===e?this.client.sendPresence({idle:{since:(new Date).toISOString()}}):this.client.sendPresence({type:e}))},e.prototype.sendPresenceToUser=function(e,t){this.connEstablished&&this.client.sendPresence({type:e,to:t})},e.prototype.connect=function(){this.obj&&this.obj.password&&this.client.connect(this.obj)},e.prototype.resetUserPresence=function(){return _.resetUserPresence(this.user.id)},e.prototype.searchMessages=function(e){return _.searchMessages(e)},e.prototype.logout=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.client){if(clearInterval(this.timeout),this.sendPresence("unavailable"),this.retryTrail=0,this.client.disconnect(),e)return this.latestMsgObj={},this.client=null,b.clear(),this.cleanDb();this.resetUserPresence()}return null},e.prototype.cleanDb=function(){return _.cleanDb().then(function(){_=void 0})},e}();function M(e){return(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&!function(){var e=window.localStorage&&window.localStorage.getItem("_bifro_storedDataTime");return!(window.sessionStorage&&window.sessionStorage.getItem("_bifro_storedData"))||!e||(Date.now()-e)/864e5>1}()?a.default.resolve():(0,u.getChatApiMetaData)(e).then(function(e){if(e.features){var t=window&&window.localStorage;t&&(t.setItem("_bifro_features",(0,i.default)(e.features)),t.setItem("_bifro_storedDataTime",Date.now()),window.sessionStorage.setItem("_bifro_storedData",!0))}e.interventions&&function(e){b.saveInterventionsData(e).then(function(e){m.default.dispatch({type:"SAVE_INTERVENTIONS_DATA",data:e})})}(e.interventions)}).catch(function(){})}t.default=function(){var e=null;return{instanceExists:function(){return null!==e&&null!==e.client},getInstance:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(){},o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:function(){},u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:function(){},d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:function(){};return new a.default(function(a){return I&&e&&e.client||e&&e.client&&e.connEstablished?(e.replaceListeners(n,s,i,r,o,u,d,t),a(e)):window.localStorage&&!window.localStorage.getItem("_bifro_features")?M(t,!1).then(function(){return I=!0,e=new k(n,s,i,r,o,u,d,t),a(e)}):(I=!0,e=new k(n,s,i,r,o,u,d,t),a(e))})}}}()}}]);
//# sourceMappingURL=desktop-xmppclient.olx.7cc268faaec676987d5f.js.map